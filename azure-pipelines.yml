trigger:
  branches:
    include:
      - main  # o 'master' segÃºn tu repositorio

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerImageName: 'ci-node-app'
  dockerTag: 'ci-$(Build.BuildId)'

steps:
  # âœ… Mostrar rama actual
  - script: |
      echo "âœ… Ejecutando en rama: $(Build.SourceBranch)"
    displayName: 'Mostrar rama actual'

  # ğŸ” DiagnÃ³stico inicial
  - script: |
      echo "ğŸ” Verificando entorno"
      docker --version
      node --version
      npm --version
    displayName: 'DiagnÃ³stico inicial'

  # ğŸ³ Construir imagen Docker (usando Dockerfile multistage)
  - task: Docker@2
    displayName: 'ğŸ³ Build imagen Docker'
    inputs:
      command: 'build'
      repository: '$(dockerImageName)'
      dockerfile: '**/Dockerfile'
      tags: |
        $(dockerTag)

  # ğŸ§ª Ejecutar pruebas dentro del contenedor (requiere script "test" en package.json)
  - script: |
      docker run --rm $(dockerImageName):$(dockerTag) npm test
    displayName: 'ğŸ§ª Ejecutar pruebas en contenedor'

  # ğŸ“ˆ Publicar cobertura (si existe el archivo cobertura)
  - task: PublishCodeCoverageResults@2
    condition: succeededOrFailed()
    displayName: 'ğŸ“ˆ Publicar cobertura (si aplica)'
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'coverage/cobertura-coverage.xml'

  # ğŸ“„ Mostrar logs si hay fallo
  - script: |
      docker ps -a
      docker logs $(docker ps -aqf "ancestor=$(dockerImageName):$(dockerTag)" || true)
    displayName: 'ğŸ“„ Mostrar logs del contenedor'
    condition: failed()
